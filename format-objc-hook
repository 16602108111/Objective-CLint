#!/usr/bin/env bash
# ~/.git_template.local/hooks/pre-commit
# format-objc-hook
# pre-commit hook to check if any unformatted Objective-C files would be committed. Fails the check if so, and provides instructions.
#
# Copyright 2015 Square, Inc

IFS=$'\n'
export CDPATH=""
DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
source "$DIR"/lib/common-lib.sh

# Don't do anything unless a .clang-format file exists
# ln -sf "$DIR/.clang-format" ".clang-format"
if [ ! -f ".clang-format" ]; then
  echo 'lost .clang-format file'
  exit 1
fi

objc_files=$(objc_files_to_format "$@")

# if not have check files quit process
if [ -z "$objc_files" ]; then 
#  echo 'not find can check object-c files'
 exit 0
fi
 
function format_objc() {
  success=0
  for file in $objc_files; do
    "$DIR"/format-objc-file-dry-run.sh "$file"
     check_file=$?
     diffrence=$(diff -q "$file" "$check_file" | wc -l)
     if [ "$diffrence" -gt 0 ]; then
         success=1
     fi
  done
   if [ $success -gt 0 ]; then
     echo -e "\033[34m 请修复以上格式问题，之后再次commit...\033[0m"
   else
     echo -e "\033[34m 恭喜您，Objective-c 没有发现问题🍺🍺🍺\033[0m"
   fi
  return $success
}

format_objc
result=$?
exit $result
